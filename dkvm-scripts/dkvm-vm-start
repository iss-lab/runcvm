#!/opt/dkvm/bin/bash

. /opt/dkvm/scripts/dkvm-ctr-defaults && PATH="$DKVM_PATH"

if [ -f /.dkvm/once ]; then
  poweroff
  exit 0
else
  touch /.dkvm/once
fi

# Change to saved PWD
cd $(cat /.dkvm/pwd)

# Load original environment
. /.dkvm/config

# Load original entrypoint
mapfile -t ARGS </.dkvm/entrypoint

# Clean DKVM env vars
clean_env

IFS=':' read -r uid gid <<< "$DKVM_UIDGID"
exec $DKVM/bin/s6-applyuidgid -u $uid -g $gid -G "" "${ARGS[@]}"