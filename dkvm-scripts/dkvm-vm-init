#!/opt/dkvm/bin/bash

DKVM=/opt/dkvm
PATH=$DKVM/sbin:$DKVM/bin:$DKVM/usr/bin
unset DKVM

# Alpine initrd doesn't honour command-line rw flag
mount -o remount,rw /

# FIXME: This must be run early enough, otherwise other interfaces like docker0 might have started
IF=$(ls /sys/class/net/ | grep -vE '^(lo|docker)' | head -n 1)

IP=$(cat /.dkvm/net)
GW=$(cat /.dkvm/netgw)

# https://bugzilla.redhat.com/show_bug.cgi?id=501934
for i in all $IF
do
  # /sbin/sysctl -q -w -e net.ipv6.conf.$i.disable_ipv6=1 net.ipv6.conf.$i.autoconf=0 net.ipv6.conf.$i.accept_ra=0
  sysctl -q -w -e net.ipv6.conf.$i.disable_ipv6=1 net.ipv6.conf.$i.autoconf=0
done

ip addr add $IP dev $IF
ip link set lo up
ip link set $IF up

route add default gw $GW
echo nameserver $GW >/etc/resolv.conf

# Setup hostname
hostname -F /etc/hostname

# 1. Run /sbin/init from the image

# Load original entrypoint and environment
mapfile -t ARGS <<< $(cat /.dkvm/entrypoint)
. /.dkvm/export

# We don't know if the original entrypoint is an init process or not.
# Work this out and do the right thing.

if [ "${ARGS[0]}" = "/sbin/init" ] || [ "$DKVM_ENTRYPOINT_IS_INIT" = "1" ]; then

  if [ -x "${ARGS[0]}" ]; then
    # Run the qemu guest agent, needed to support 'docker exec'
  
    # TODO:
    # - Add option to inhibit this
    /opt/dkvm/scripts/dkvm-vm-qemu-ga &
  
    # Run init from the image
    exec -c "${ARGS[0]}"
  fi
fi

# 2. Run our own /opt/dkvm/bin/init

cat >/etc/inittab <<_EOE_
ttyS0::respawn:-/opt/dkvm/scripts/dkvm-vm-start
::respawn:/opt/dkvm/scripts/dkvm-vm-qemu-ga
::ctrlaltdel:/opt/dkvm/bin/poweroff
::restart:/opt/dkvm/bin/poweroff
_EOE_

# Allow dkvm-vm-start to runs once (and only once)
rm -f /.dkvm/once

# Run our own init
exec -c /opt/dkvm/bin/init
